name: Final Rescue Build
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Environment
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      - uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Clean and Build
        run: |
          # 1. Очистка: удаляем следы прошлых неудачных попыток
          rm -rf android node_modules package-lock.json capacitor.config.* www

          # 2. Подготовка файлов сайта
          mkdir www
          # Копируем файлы (команда '|| true' не дает скрипту упасть, если файлов нет)
          cp *.html www/ 2>/dev/null || true
          cp *.js www/ 2>/dev/null || true
          cp *.css www/ 2>/dev/null || true
          cp *.json www/ 2>/dev/null || true
          
          # Удаляем package.json из папки www, чтобы он не мешал
          rm www/package.json 2>/dev/null || true

          # 3. Установка "мозгов" (Capacitor) с нуля
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android

          # 4. Настройка Android-проекта
          npx cap init MyVaultApp com.vault.app --web-dir www --npm-client npm
          npx cap add android

          # 5. Сборка APK
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: vault-app-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
