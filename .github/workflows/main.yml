name: Auto Build APK
on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. Ставим Node.js для работы с Capacitor
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # 2. Устанавливаем Capacitor и ваши плагины
      - name: Install Dependencies
        run: |
          npm install
          npm install @capacitor/core @capacitor/cli @capacitor/android

      # 3. Создаем правильную структуру папок (переносим сайт в папку www)
      - name: Prepare Web Assets
        run: |
          mkdir -p www
          cp -r *.html *.js *.json www/ 2>/dev/null || :
          # Возвращаем package.json в корень, он нужен для установки
          cp www/package.json . 2>/dev/null || :

      # 4. Генерируем Android-проект с нуля (именно этого не хватало!)
      - name: Init Capacitor Android
        run: |
          npx cap init MyVaultApp com.vault.app --web-dir www --npm-client npm
          npx cap add android

      # 5. Настраиваем Java
      - uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      # 6. Собираем APK
      - name: Build APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug

      # 7. Загружаем готовый файл
      - name: Upload APK
        uses: actions/upload-artifact@v3
        with:
          name: vault-app-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
